/***************************************************
 *         Author: Shawn Guo                       *
 *         Date  : 2013/2/12                       *
 *         Last  : 2013/2/12                       *
 *         Notes : Buzzer                          *
 *         P1.5短路帽                                 *
 **************************************************/

#include <reg52.h>

sbit beep = P1^5;

unsigned char COUNT = 0;  //COUNT为节拍常数变量,需要在中断函数中处理，因此设置为全局变量
unsigned char code MUSIC_TAB[] = {
0x18, 0x30, 0x1C , 0x10, //格式为: 频率常数, 节拍常数, 频率常数, 节拍常数...
0x20, 0x40, 0x1C , 0x10,
0x18, 0x10, 0x20 , 0x10,
0x1C, 0x10, 0x18 , 0x40,
0x1C, 0x20, 0x20 , 0x20,
0x1C, 0x20, 0x18 , 0x20,
0x20, 0x80, 0xFF , 0x20,
0x30, 0x1C, 0x10 , 0x18,
0x20, 0x15, 0x20 , 0x1C,
0x20, 0x20, 0x20 , 0x26,
0x40, 0x20, 0x20 , 0x2B,
0x20, 0x26, 0x20 , 0x20,
0x20, 0x30, 0x80 , 0xFF,
0x20, 0x20, 0x1C , 0x10,
0x18, 0x10, 0x20 , 0x20,
0x26, 0x20, 0x2B , 0x20,
0x30, 0x20, 0x2B , 0x40,
0x20, 0x20, 0x1C , 0x10,
0x18, 0x10, 0x20 , 0x20,
0x26, 0x20, 0x2B , 0x20,
0x30, 0x20, 0x2B , 0x40,
0x20, 0x30, 0x1C , 0x10,
0x18, 0x20, 0x15 , 0x20,
0x1C, 0x20, 0x20 , 0x20,
0x26, 0x40, 0x20 , 0x20,
0x2B, 0x20, 0x26 , 0x20,
0x20, 0x20, 0x30 , 0x80,
0x20, 0x30, 0x1C , 0x10,
0x20, 0x10, 0x1C , 0x10,
0x20, 0x20, 0x26 , 0x20,
0x2B, 0x20, 0x30 , 0x20,
0x2B, 0x40, 0x20 , 0x15,
0x1F, 0x05, 0x20 , 0x10,
0x1C, 0x10, 0x20 , 0x20,
0x26, 0x20, 0x2B , 0x20,
0x30, 0x20, 0x2B , 0x40,
0x20, 0x30, 0x1C , 0x10,
0x18, 0x20, 0x15 , 0x20,
0x1C, 0x20, 0x20 , 0x20,
0x26, 0x40, 0x20 , 0x20,
0x2B, 0x20, 0x26 , 0x20,
0x20, 0x20, 0x30 , 0x30,
0x20, 0x30, 0x1C , 0x10,
0x18, 0x40, 0x1C , 0x20,
0x20, 0x20, 0x26 , 0x40,
0x13, 0x60, 0x18 , 0x20,
0x15, 0x40, 0x13 , 0x40,
0x18, 0x80, 0x00               // 0x00表示单曲结束, 0xff表示休止符
};

void Delay(unsigned int x);
void Delayms(unsigned int xms);
void Beep();   // simple demo
void Song();   // beep a song

int main()
{
    //Beep();
    Song();

    return 0;
}

void Delay(unsigned int m)   //控制频率延时
{
    unsigned int i = 3 * m;

    while(--i)
        ;
}

void Delayms(unsigned int xms)      // 毫秒级延时
{
    while(--xms)            // --xms 与 xms-- 在汇编层次有差距
        ;
}

// 控制声调声色大小：改变频率
// 控制声音大小：改变输出电平的占空比
void Beep()
{
    beep = 0;   //低电平接通蜂鸣器，音频信号通过电磁线圈，产生磁场驱动膜片发声
    Delayms(500);
    beep = 1;
    Delayms(200);
}

void Song()
{
    unsigned char p, m;   //m为频率常数变量
    unsigned char i = 0;

    TMOD &= 0x0f;
    TMOD |= 0x01;
    TH0 = 0xd8;
    TL0 = 0xef;
    IE = 0x82;   // equal {EA = 1; ET0 = 1;}

    while(1)
    {
        p = MUSIC_TAB[i];   // 取数据

        if(p == 0x00)//如果碰到结束符,延时1秒,回到开始再来一遍
        {
            i = 0;
            Delayms(1000);
            continue;
        }

        else if(p == 0xff)   //若碰到休止符,延时100ms,继续取下一音符
        {
            i = i + 1;
            TR0 = 0;   //停止定时器中断
            Delayms(100);
            continue;
        }
        else{  //取频率常数 和 节拍常数
                m = MUSIC_TAB[i++];
                COUNT = MUSIC_TAB[i++];
            }

        TR0=1;       //开定时器0
        while(COUNT != 0)//等待节拍完成, 通过P1口输出音频(可多声道哦!)
        {
            beep = ~beep;
            Delay(m);
        }
        TR0 = 0;    //关定时器0
    }

}

void Time0()  interrupt 1   //采用定时器0 中断0 控制节拍
{
    // 定时器重装初值
    TH0 = 0xd8;
    TL0 = 0xef;

    //自定义操作
    COUNT--;
}
